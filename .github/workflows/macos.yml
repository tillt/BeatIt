name: macos

permissions:
  contents: write

on:
  push:
    branches: [main]
    tags: ["v*"]
  pull_request:

jobs:
  build:
    runs-on: macos-14
    env:
      BEATIT_TEST_CPU_ONLY: "1"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          brew list --versions ninja >/dev/null 2>&1 || brew install ninja
          brew list --versions pytorch >/dev/null 2>&1 || brew install pytorch

      - name: Resolve Torch prefix
        run: echo "BEATIT_TORCH_ROOT=$(brew --prefix pytorch)" >> "$GITHUB_ENV"

      - name: Configure
        run: cmake -S . -B build -G Ninja -DCMAKE_BUILD_TYPE=Release -DBEATIT_TORCH_ROOT="${BEATIT_TORCH_ROOT}"

      - name: Build
        run: cmake --build build

      - name: Verify plugins are staged
        run: |
          test -f build/plugins/libbeatit_backend_coreml.dylib
          test -f build/plugins/libbeatit_backend_torch.dylib
          test -f build/BeatIt.framework/Versions/A/Resources/plugins/libbeatit_backend_coreml.dylib
          test -f build/BeatIt.framework/Versions/A/Resources/plugins/libbeatit_backend_torch.dylib

      - name: Test
        run: ctest --test-dir build --output-on-failure

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: beatit-macos-build
          path: |
            build/beatit
            build/plugins
            build/BeatIt.framework

  notarize:
    runs-on: macos-14
    environment: Release
    needs: build
    if: github.ref_type == 'tag'
    env:
      BEATIT_TEST_CPU_ONLY: "1"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          brew list --versions ninja >/dev/null 2>&1 || brew install ninja
          brew list --versions pytorch >/dev/null 2>&1 || brew install pytorch

      - name: Resolve Torch prefix
        run: echo "BEATIT_TORCH_ROOT=$(brew --prefix pytorch)" >> "$GITHUB_ENV"

      - name: Import signing certificate
        env:
          MACOS_CERTIFICATE: ${{ secrets.MAC_CERT_P12_BASE64 }}
          MACOS_CERTIFICATE_PASSWORD: ${{ secrets.MAC_CERT_PASS }}
          KEYCHAIN_PASSWORD: ${{ secrets.MAC_KEYCHAIN_PASS }}
        run: |
          if [ -z "$MACOS_CERTIFICATE" ]; then
            echo "Missing MAC_CERT_P12_BASE64 secret."
            exit 1
          fi
          if [ -z "$KEYCHAIN_PASSWORD" ]; then
            echo "Missing MAC_KEYCHAIN_PASS secret."
            exit 1
          fi
          echo "$MACOS_CERTIFICATE" | base64 --decode > signing.p12
          security create-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security import signing.p12 -k build.keychain -P "$MACOS_CERTIFICATE_PASSWORD" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" build.keychain

      - name: Configure
        run: cmake -S . -B build -G Ninja -DCMAKE_BUILD_TYPE=Release -DBEATIT_TORCH_ROOT="${BEATIT_TORCH_ROOT}"

      - name: Build
        run: cmake --build build

      - name: Verify plugins are staged
        run: |
          test -f build/plugins/libbeatit_backend_coreml.dylib
          test -f build/plugins/libbeatit_backend_torch.dylib
          test -f build/BeatIt.framework/Versions/A/Resources/plugins/libbeatit_backend_coreml.dylib
          test -f build/BeatIt.framework/Versions/A/Resources/plugins/libbeatit_backend_torch.dylib

      - name: Codesign artifacts
        env:
          MACOS_SIGN_IDENTITY: ${{ secrets.MAC_CODESIGN_ID }}
        run: |
          if [ -z "$MACOS_SIGN_IDENTITY" ]; then
            echo "Missing MAC_CODESIGN_ID secret."
            exit 1
          fi
          if [ -d build/plugins ]; then
            find build/plugins -name '*.dylib' -print0 | while IFS= read -r -d '' dylib; do
              codesign --force --options runtime --timestamp --sign "$MACOS_SIGN_IDENTITY" "$dylib"
            done
          fi
          codesign --force --options runtime --timestamp --sign "$MACOS_SIGN_IDENTITY" build/BeatIt.framework
          codesign --force --options runtime --timestamp --sign "$MACOS_SIGN_IDENTITY" build/beatit

      - name: Package for notarization
        run: |
          mkdir -p dist/BeatIt
          cp -R build/BeatIt.framework dist/BeatIt/
          cp build/beatit dist/BeatIt/
          if [ -d build/plugins ]; then
            mkdir -p dist/BeatIt/plugins
            cp -R build/plugins/. dist/BeatIt/plugins/
          fi
          mkdir -p dist/BeatIt/models
          cp -R models/BeatThis_small0.mlpackage dist/BeatIt/models/BeatThis_small0.mlpackage
          ditto -c -k --sequesterRsrc --keepParent dist/BeatIt dist/beatit-macos.zip

      - name: Notarize
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PWD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          if [ -z "$APPLE_ID" ] || [ -z "$APPLE_APP_PASSWORD" ] || [ -z "$APPLE_TEAM_ID" ]; then
            echo "Missing Apple notarization secrets."
            exit 1
          fi
          xcrun notarytool submit dist/beatit-macos.zip \
            --apple-id "$APPLE_ID" \
            --team-id "$APPLE_TEAM_ID" \
            --password "$APPLE_APP_PASSWORD" \
            --wait

      - name: Draft release
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          files: dist/beatit-macos.zip

  homebrew:
    runs-on: macos-14
    needs: build
    if: github.ref_type == 'tag'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install ninja
        run: brew list --versions ninja >/dev/null 2>&1 || brew install ninja

      - name: Tap repository
        run: brew tap tillt/beatit "$GITHUB_WORKSPACE"

      - name: Install from formula
        run: brew install --HEAD --build-from-source tillt/beatit/beatit

      - name: Test formula
        run: brew test beatit
